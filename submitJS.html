<script>

function submit(){
  var buyerName = document.getElementById('nameReferral').value
  var buyerPhone = document.getElementById('phoneReferral').value
  var buyerEmail = document.getElementById('emailReferral').value
  var street = document.getElementById('streetReferral').value
  var city = document.getElementById('cityReferral').value
  var zip = document.getElementById('zipReferral').value
  var notes = document.getElementById('notesReferral').value
  var typeE = document.getElementById('type')
  var type = typeE.options[typeE.selectedIndex].text
  var sourceE = document.getElementsByClassName('sourceClass')[0]
  var source = sourceE.options[sourceE.selectedIndex].text
  var listingAgentE = document.getElementById('dropdownLA')
  var listingAgent = listingAgentE.options[listingAgentE.selectedIndex].text
  var baSelectE = document.getElementById('baSelect')
  var baSelect = baSelectE.options[baSelectE.selectedIndex].text
  var baInput = document.getElementById('baInput').value
  var checked = document.getElementById('checkbox').checked
  
  if (!document.submitReady){
    return console.log('Submit not ready.')
  }
  
  var userType 
  if (listingAgent === 'None'){
    userType = document.user.userType
  }
  else {
    userType = 'Listing Agent'
  }
  
  // reset type if needed
  if (type === 'choose...' || type === ''){type = ''}
  
  // reset source if needed
  if (source === 'choose...' || type === 'Homie Seller' || type === 'SOI') {source = ''}
  
  // reset listingAgent if needed 
  if (listingAgent === 'choose...'){listingAgent = ''}
  
  // Find or create buyerAgent object
  var buyerAgent = ''
  var baId
  if (checked){
    baId = 'baSelect' // name of element id to reset
    if (baSelect === 'choose...'){
      buyerAgent = {name: ''}
    }
    else {
      var buyerAgents = document.buyerAgents
      var agentInfo = buyerAgents.filter(function(agent){
        return agent.name == baSelect.split(' (')[0] // remove distance if any
      })
    
      buyerAgent = agentInfo[0]
    }
  }
  else {
    baId = 'baInput' // name of element id to reset
    var buyerAgents = document.buyerAgents
    var agentInfo = buyerAgents.filter(function(agent){
      return agent.name == baInput
    })
    
    // send buyerAgent found on document if name matches
    if (agentInfo.length > 0){
      buyerAgent = agentInfo[0]
    }
    
    // for unfound buyerAgent name inputs, send new data
    else {
      buyerAgent = {
        name: baInput,
        email: 'mike.degroot@homie.com',
        ssId: '1HHuqqbnmW1ihOJDkQW7tfppNovoeELtifjrhSm-Yf1U'
      }
    }
  }
  buyerAgent.baId = baId  // element id to reset
  
  var details = {
    buyerName: buyerName,
    buyerPhone: buyerPhone,
    buyerEmail: buyerEmail,
    street: street,
    city: city,
    zip: zip,
    notes: notes,
    type: type,
    source: source,
    referringName: listingAgent,
    referringType: userType,
    buyerAgent: buyerAgent
  }
  
  var submitReady = checkForBlanks(details)
  if (submitReady){
    return runSubmit(details)
  }
  else {
    return showMessage(false, 'Please complete all required fields.')
  }
}

function runSubmit(details){

  var user = document.user

  // show loading view
  showLoading(true, 'submitting referral') 
  
  google.script.run  
  .withSuccessHandler(function(res){
  
    console.log('Done. Time taken: ' + res.loadTime + 's')
  
    // if no error, continue
    if (!res.error){
      showMessage(true, res.message)
      clearValues() // clear values and dropdowns
      showLoading(false, '')
      runGetData() // reload data to bring in updated info
    }
    
    // handle errors
    else {
      showMessage(false, res.message)
      showLoading(false, '')
    }
  })
  
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
    showMessage(false, 'Something went wrong. Please try again later.')
    showLoading(false, '')
  })
  .submit(details)
}

function tabUpdate(className){
  var eOld = document.getElementById('activeTab')
  var eNew = document.getElementsByClassName(className)[0]
  var tab1a = document.getElementsByClassName('tab1a')[0]
  var tab1b = document.getElementsByClassName('tab1b')[0]
  var tab1c = document.getElementsByClassName('tab1c')[0]
  var dash = document.getElementsByClassName('dash')[0]
  var form = document.getElementsByClassName('newReferral')[0]
  var queue = document.getElementsByClassName('queue')[0]
  
  // add id to selected element, remove from other
  eOld.removeAttribute('id')
  eNew.setAttribute('id', 'activeTab')

  if (className == 'tab1a'){
    form.style.display = 'flex'
    dash.style.display = 'none'
    queue.style.display = 'none'
    tab1b.style.borderRight = '1px solid #aaaaaa'
    tab1b.style.borderLeft = 'none'
    resetGraph()
  }
  else if (className == 'tab1b'){
    form.style.display = 'none'
    dash.style.display = 'flex'
    queue.style.display = 'none'
    tab1b.style.borderRight = '1px solid #aaaaaa'
    tab1b.style.borderLeft = '1px solid #aaaaaa'
    updateGraph()
  }
  else if (className == 'tab1c'){
    form.style.display = 'none'
    dash.style.display = 'none'
    queue.style.display = 'flex'
    tab1b.style.borderLeft = '1px solid #aaaaaa'
    tab1b.style.borderRight = 'none'
    resetGraph()
  }
}

function updateGraph(){
  setTimeout(() => {
    var barUCHeight = document.user.barUCHeight
    var barOfferHeight = document.user.barOfferHeight
    var barTourHeight = document.user.barTourHeight
    var barSearchHeight = document.user.barSearchHeight
    var barLeadHeight = document.user.barLeadHeight
    var pct = .8
    document.getElementById('barUC').style.height = (barUCHeight * pct) + '%'
    document.getElementById('barOffer').style.height = (barOfferHeight * pct) + '%'
    document.getElementById('barTour').style.height = (barTourHeight * pct) + '%'
    document.getElementById('barSearch').style.height = (barSearchHeight * pct) + '%'
    document.getElementById('barLead').style.height = (barLeadHeight * pct) + '%'
    for (var i = 0; i < 5; i++){
      document.getElementsByClassName('num')[i].style.opacity = 1
    }
    
    document.getElementById('submitCount').style.opacity = 1
    document.getElementById('closedCount').style.opacity = 1
    document.getElementById('sellerPct').style.opacity = 1
    document.getElementById('closedSum').style.opacity = 1
    document.getElementsByClassName('leaderboardList')[0].style.opacity = 1
  }, 10)
}

function resetGraph(){
  document.getElementById('barUC').style.height = 0
  document.getElementById('barOffer').style.height = 0
  document.getElementById('barTour').style.height = 0
  document.getElementById('barSearch').style.height = 0
  document.getElementById('barLead').style.height = 0
  for (var i = 0; i < 5; i++){
    document.getElementsByClassName('num')[i].style.opacity = 0
  }
  
  document.getElementById('submitCount').style.opacity = 0
  document.getElementById('closedCount').style.opacity = 0
  document.getElementById('sellerPct').style.opacity = 0
  document.getElementById('closedSum').style.opacity = 0
  document.getElementsByClassName('leaderboardList')[0].style.opacity = 0
}

</script>