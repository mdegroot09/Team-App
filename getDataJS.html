<script>

window.addEventListener('load', load())

function load() {
  
  // show loading view
  showLoading(true, 'pulling user info')
  
  // Get user info
  google.script.run  
  // if successful, display the data 
  .withSuccessHandler(function(res){
    document.user = res.user
    displayUserInfo(res.user) // display user info on DOM
    updateListingAgents(res.listingAgents) // add listing agents to dropdown options
    runGetData('collecting referrals') // display data based on user info
  })
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
  })
  .getUserInfo()
}

function runGetData(loadText){

  var user = document.user

  showLoading(true, loadText) // show loading view

  // Get data from spreadsheet 
  google.script.run
  // if successful, display the data 
  .withSuccessHandler(function(res){
    showLoading(false, '') // hide loading view
    document.data = res.data
    document.citiesZips = res.citiesZips
    showData(res.data) // show the referral data
    updateDashboard(res.data)
    console.log('Page is loaded')
  })
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
  })
  .getData(user) // run function in gs file to pull data
}

function displayUserInfo(user){
  var userInfoHTML = ''
  userInfoHTML += '<div>' + user.userName + '</div>'
  userInfoHTML += '<div id="userType">' + user.userType + '</div>'
  document.getElementById('userInfo').innerHTML = userInfoHTML
}

function showData(data){

  // display buyer names
  var buyerNamesHTML = ''
  var buyerAgentsHTML = ''
  var stagesHTML = ''
  var listingAgentsHTML = ''
  
  // display data if there is any
  if (data.length > 0){
    for (var i = 0; i < data.length; i++){
      var background, bottomBorder, stage, lost, bottomLeftRadius, bottomRightRadius;
      
      // show lost if applicable, otherwise show stage
      if (data[i].status == 'Lost'){
        stage = data[i].status
        lost = ' lost'
      }
      else {
        stage = data[i].stage
        lost = ''
      }
      
      // show solid bottom border
      if (i !== (data.length - 1)){
        bottomBorder = ''
        bottomLeftRadius = ''
        bottomRightRadius = ''
      }
      else {
        bottomBorder = ' bottom'
        bottomLeftRadius = '; border-bottom-left-radius: 5px;'
        bottomRightRadius = '; border-bottom-right-radius: 5px;'
      }
      
      // set class name per row number for background color
      if (i % 3 === 0){
        background = 'rowOne'
      }
      else if (i % 3 === 1){
        background = 'rowTwo'
      }
      else {
        background = 'rowThree'
      }
    
      buyerNamesHTML += '<div class="rowEach ' + background + bottomBorder + '" style="border-left: solid 1px #58dbc2' + bottomLeftRadius + '"><span>' + data[i].buyerName + '</span></div>'
      buyerAgentsHTML += '<div class="rowEach ' + background + bottomBorder + '"><span>' + data[i].buyerAgent + '</span></div>'
      stagesHTML += '<div class="rowEach ' + background + bottomBorder + lost + '"><span>' + stage + '</span></div>'
      listingAgentsHTML += '<div class="rowEach ' + background + bottomBorder + '" style="border-right: solid 1px #58dbc2' + bottomRightRadius + '"><span>' + data[i].listingAgent + '</span></div>'
    }
  }
  
  // if no data, show empty row
  else {
    buyerNamesHTML += '<div class="rowEach rowOne bottom" style="border-left: solid 1px #58dbc2; border-bottom-left-radius: 5px;"><span>No referrals</span></div>'
    buyerAgentsHTML += '<div class="rowEach rowOne bottom"></div>'
    stagesHTML += '<div class="rowEach rowOne bottom"></div>'
    listingAgentsHTML += '<div class="rowEach rowOne bottom" style="border-right: solid 1px #58dbc2; border-bottom-right-radius: 5px;"></div>'
  }
  
  document.getElementById('showBuyers').innerHTML = buyerNamesHTML
  document.getElementById('showBuyerAgents').innerHTML = buyerAgentsHTML
  document.getElementById('showStages').innerHTML = stagesHTML
  document.getElementById('showListingAgents').innerHTML = listingAgentsHTML
}

function updateListingAgents(listingAgents){
  var dropdownLA = document.getElementById('dropdownLA')
  var html = dropdownLA.innerHTML
  
  for (var i = 0; i < listingAgents.length; i++){
    html += '<option value="' + (i + 1) + '">' + listingAgents[i] + '</option>'
  }
  
  // update html to show listing agents in dropdown
  dropdownLA.innerHTML = html
  
  // if user is listing agent, search for name in la dropdown then lock
  var user = document.user
  if (user.userType == 'Listing Agent'){
    var value
    listingAgents.forEach(function(agent, i){
      if (agent == user.userName){
        value = i + 1
      }
    })
    
    // lock la dropdown if user is found 
    if (value){
      var e = document.getElementById('dropdownLA')
      e.style.background = '#ededed'
      e.style.cursor = 'default'
      e.disabled = true
      e.value = value
    }
  }
}

function showLoading(show, text){
  var displayBack, displayLoading, displayLoadText
  if (show){
    displayBack = 'flex'
    displayLoading = 'block'
    displayLoadText = 'block'
  }
  else {
    displayBack = 'none'
    displayLoading = 'none'
    displayLoadText = 'none'
  }
  document.getElementById('loadBack').style.display = displayBack
  document.getElementById('loading').style.display = displayLoading
  document.getElementById('loadingText').style.display = displayLoadText
  document.getElementById('loadingText').innerText = text
}

function showMessage(success, text){
  var e = document.getElementById('message')
  e.innerText = text
  e.style.display = 'block'
  
  // show success message
  if (success){
    e.style.background = '#cff9f1'
    e.style.color = '#45c2aa'
    e.style.border = '#45c2aa 1px solid'
  }
  
  // show failure message
  else {
    e.style.background = '#f4cccc'
    e.style.color = '#b60000'
    e.style.border = '#b60000 1px solid'
  }
    
  setTimeout(function(){ 
    e.style.display = 'none' 
  }, 7000)
}

function updateDashboard(data){
  var submitCount, closedCount, sellerToBuyerPct, closedSum
}

</script>