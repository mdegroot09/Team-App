<script>

function submit(){
  var buyerName = document.getElementById('nameReferral').value
  var buyerPhone = document.getElementById('phoneReferral').value
  var buyerEmail = document.getElementById('emailReferral').value
  var street = document.getElementById('streetReferral').value
  var city = document.getElementById('cityReferral').value
  var zip = document.getElementById('zipReferral').value
  var notes = document.getElementById('notesReferral').value
  var typeE = document.getElementById('referralType')
  var type = typeE.options[typeE.selectedIndex].text
  var sourceE = document.getElementsByClassName('sourceClass')[0]
  var source = sourceE.options[sourceE.selectedIndex].text
  
  if (source === 'choose...' || type === 'Homie Seller' || type === 'SOI') {
    source = ''
  }
  
  var e = document.getElementById('dropdownLA')
  var listingAgent = e.options[e.selectedIndex].text
  var userType 
  if (listingAgent == 'None'){
    userType = document.user.userType
  }
  else {
    userType = 'Listing Agent'
  }
  
  var details = {
    buyerName: buyerName,
    buyerPhone: buyerPhone,
    buyerEmail: buyerEmail,
    street: street,
    city: city,
    zip: zip,
    notes: notes,
    type: type,
    source: source,
    referringName: listingAgent,
    referringType: userType
  }
  
//  checkForBlanks(details)
  runSubmitReferral(details)
}

function updateSourceStyling(){
  var typeE = document.getElementById('referralType')
  var type = typeE.options[typeE.selectedIndex].text
  var e = document.getElementsByClassName('sourceClass')[0]
  
  // enable source dropdown
  if (type !== 'choose...' && type !== 'Homie Seller' && type !== 'SOI'){
    e.removeAttribute("id")
    e.disabled = false
  }
  
  // disable source dropdown
  else {
    e.setAttribute("id", "source")
    e.disabled = true
  }
}

function runSubmitReferral(details){

  // show loading view
  showLoading(true) 
  
  google.script.run  
  .withSuccessHandler(function(res){
  
    // if no error, continue
    if (!res.error){
      showMessage(true, res.message)
      clearValues() // clear values and dropdowns
      load() // reload data to bring in updated info
    }
    
    // handle errors
    else {
      showMessage(false, res.message)
      showLoading(false)
    }
  })
  
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
    showMessage(false, 'Something went wrong. Please try again later.')
    showLoading(false)
  })
  .submitReferral(details)
}

function clearValues(){

  // reset values to empty strings
  document.getElementById('nameReferral').value = ''
  document.getElementById('phoneReferral').value = ''
  document.getElementById('emailReferral').value = ''
  document.getElementById('streetReferral').value = ''
  document.getElementById('cityReferral').value = ''
  document.getElementById('zipReferral').value = ''
  document.getElementById('notesReferral').value = ''
  
  // reset dropdowns to default
  document.getElementById('referralType').value = 0
  document.getElementsByClassName('sourceClass')[0].value = 0
  
  // reset display of sourceElements to 'none'
  var e = document.getElementsByClassName('sourceElements')
  for (var i = 0; i < e.length; i++){
    e[i].style.display = 'none'
  }
}

//function runUpdateLocation(){
//  var city, zip
//  if (id == 'cityReferral'){
//    city = val
//    zip = document.getElementById('zipReferral').value
//  }
//  else {
//    city = document.getElementById('cityReferral').value
//    zip = val
//  }
//  
//  // update city name using zip
//  if (!city && zip){
//    if (String(zip).split('').length >= 5){ // if zip length is at least 5
//      
//    }
//  }
//  
//  // update zip using city name
//  if (!zip && city){
//    
//    showLoading(true) // show loading view
//    
//    // Get user info
//    google.script.run  
//    // if successful, display the data 
//    .withSuccessHandler(function(res){
//      if (!res.error && res.update){
//        document.getElementById('cityReferral').value = res.city
//        document.getElementById('zipReferral').value = res.zip
//        console.log('Successful update')
//      }
//      showLoading(false)
//      
//    })
//    // if error
//    .withFailureHandler(function(err){
//      console.error("error occured", err)
//      showLoading(false)
//    })
//    .updateLocation(zip, city)
//    
//  }
//}

function updateCity(zip){
  var citiesZips = document.citiesZips
  var city = document.getElementById('cityReferral').value
  
  var zipMatches = citiesZips.filter(function(val, i){
    return val.zip == zip
  })
  
  // if only one zip code result
  if (zipMatches.length === 1){
    city = zipMatches[0].city
  }
  
  // if multiple zip code results
  else if (zipMatches.length > 1){
    var cityMatches = zipMatches.filter(function(val){
      return val.city == city
    })
    
    // if city already matches, keep it the same
    if (cityMatches.length > 0){
      city = cityMatches[0].city
    }
    
    // if no city matches, use first one found in zipMatches
    else {
      city = zipMatches[0].city
    }
  }
  
  document.getElementById('cityReferral').value = city
}

</script>