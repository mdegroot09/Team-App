<script>

function submit(){
  var buyerName = document.getElementById('nameReferral').value
  var buyerPhone = document.getElementById('phoneReferral').value
  var buyerEmail = document.getElementById('emailReferral').value
  var street = document.getElementById('streetReferral').value
  var city = document.getElementById('cityReferral').value
  var zip = document.getElementById('zipReferral').value
  var notes = document.getElementById('notesReferral').value
  var typeE = document.getElementById('type')
  var type = typeE.options[typeE.selectedIndex].text
  var sourceE = document.getElementsByClassName('sourceClass')[0]
  var source = sourceE.options[sourceE.selectedIndex].text
  var listingAgentE = document.getElementById('dropdownLA')
  var listingAgent = listingAgentE.options[listingAgentE.selectedIndex].text
  var baSelectE = document.getElementById('baSelect')
  var baSelect = baSelectE.options[baSelectE.selectedIndex].text
  var baInput = document.getElementById('baInput').value
  var checked = document.getElementById('checkbox').checked
  
  if (!document.submitReady){
    return console.log('Submit not ready.')
  }
  
  var userType 
  if (listingAgent === 'None'){
    userType = document.user.userType
  }
  else {
    userType = 'Listing Agent'
  }
  
  // reset type if needed
  if (type === 'choose...' || type === ''){type = ''}
  
  // reset source if needed
  if (source === 'choose...' || type === 'Homie Seller' || type === 'SOI') {source = ''}
  
  // reset listingAgent if needed 
  if (listingAgent === 'choose...'){listingAgent = ''}
  
  // Find or create buyerAgent object
  var buyerAgent = ''
  var baId
  if (checked){
    baId = 'baSelect' // name of element id to reset
    if (baSelect === 'choose...'){
      buyerAgent = {name: ''}
    }
    else {
      var buyerAgents = document.buyerAgents
      var agentInfo = buyerAgents.filter(function(agent){
        return agent.name == baSelect.split(' (')[0] // remove distance if any
      })
    
      buyerAgent = agentInfo[0]
    }
  }
  else {
    baId = 'baInput' // name of element id to reset
    var buyerAgents = document.buyerAgents
    var agentInfo = buyerAgents.filter(function(agent){
      return agent.name == baInput
    })
    
    // send buyerAgent found on document if name matches
    if (agentInfo.length > 0){
      buyerAgent = agentInfo[0]
    }
    
    // for unfound buyerAgent name inputs, send new data
    else {
      buyerAgent = {
        name: baInput,
        email: 'leads@homie.com',
        url: 'https://docs.google.com/spreadsheets/d/1HHuqqbnmW1ihOJDkQW7tfppNovoeELtifjrhSm-Yf1U/edit?usp=sharing'
      }
    }
  }
  buyerAgent.baId = baId  // element id to reset
  
  notes = handleQuotes(notes)
  
  var details = {
    buyerName: buyerName,
    buyerPhone: buyerPhone,
    buyerEmail: buyerEmail,
    street: street,
    city: city,
    zip: zip,
    notes: notes,
    type: type,
    source: source,
    referringName: listingAgent,
    referringType: userType,
    buyerAgent: buyerAgent
  }
  
  var submitReady = checkForBlanks(details)
  if (submitReady){
    return runSubmit(details)
  }
  else {
    return showMessage(false, 'Please complete all required fields.')
  }
}

function handleQuotes(notes){
  var str = notes.split('').map(function(val){
    if (val == '"'){
      return '\"'
    }
    else {
      return val
    }
  }).join('')
  
  return str
}

function runSubmit(details){

  var user = document.user

  // show loading view
  showLoading(true, 'submitting referral') 
  
  google.script.run  
  .withSuccessHandler(function(res){
  
    console.log('Done. Time taken: ' + res.loadTime + 's')
  
    // if no error, continue
    if (!res.error){
      showMessage(true, res.message)
      clearValues() // clear values and dropdowns
      showLoading(false, '')
      runGetData() // reload data to bring in updated info
    }
    
    // handle errors
    else {
      showMessage(false, res.message)
      showLoading(false, '')
    }
  })
  
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
    google.script.run.sendErrorEmail(err, 'Submit Error')
    showMessage(false, 'Something went wrong. Please try again later.')
    showLoading(false, '')
  })
  .submit(details)
}

function tabUpdate(className, num){
  var eOld = document.getElementById('activeTab' + num)
  var eNew = document.getElementsByClassName(className)[0]
  var tabA = document.getElementsByClassName('tab' + num + 'a')[0]
  var tabB = document.getElementsByClassName('tab' + num + 'b')[0]
  var tabC = document.getElementsByClassName('tab' + num + 'c')[0]
  var form = document.getElementsByClassName('newReferral')[0]
  var dash = document.getElementsByClassName('dash')[0]
  var queue = document.getElementsByClassName('queue')[0]
  var opps = document.getElementsByClassName('opps')[0]
  var leads = document.getElementsByClassName('leads')[0]
  var closed = document.getElementsByClassName('closed')[0]
  var lost = document.getElementsByClassName('lost')[0]
  
  // add id to selected element, remove from other
  eOld.removeAttribute('id')
  eNew.setAttribute('id', 'activeTab' + num)

  if (className == 'tab' + num + 'a'){
    tabB.style.borderLeft = 'none'
    tabB.style.borderRight = '1px solid #aaaaaa'
    tabC.style.borderRight = '1px solid #aaaaaa'
    
    if (className == 'tab1a'){
      form.style.display = 'flex'
      dash.style.display = 'none'
      queue.style.display = 'none'
      resetGraph()
    }
    else if (className == 'tab2a'){
      opps.style.display = 'flex'
      leads.style.display = 'none'
      closed.style.display = 'none'
      lost.style.display = 'none'
    }
  }
  else if (className == 'tab' + num + 'b'){
    tabB.style.borderLeft = '1px solid #aaaaaa'
    tabB.style.borderRight = '1px solid #aaaaaa'
    tabC.style.borderRight = '1px solid #aaaaaa'
    
    if (className == 'tab1b'){
      form.style.display = 'none'
      dash.style.display = 'flex'
      queue.style.display = 'none'
      updateGraph()
    }
    else if (className == 'tab2b'){
      opps.style.display = 'none'
      leads.style.display = 'flex'
      closed.style.display = 'none'
      lost.style.display = 'none'
    }
  }
  else if (className == 'tab' + num + 'c'){
    tabB.style.borderLeft = '1px solid #aaaaaa'
    tabB.style.borderRight = 'none'
    tabC.style.borderRight = '1px solid #aaaaaa'
    
    if (className == 'tab1c'){
      form.style.display = 'none'
      dash.style.display = 'none'
      queue.style.display = 'flex'
      resetGraph()
    }
    else if (className == 'tab2c'){
      opps.style.display = 'none'
      leads.style.display = 'none'
      closed.style.display = 'flex'
      lost.style.display = 'none'
    }
  }
  else if (className == 'tab' + num + 'd'){
    tabB.style.borderLeft = '1px solid #aaaaaa'
    tabB.style.borderRight = '1px solid #aaaaaa'
    tabC.style.borderRight = 'none'
    
    if (className == 'tab1d'){
      form.style.display = 'none'
      dash.style.display = 'none'
      queue.style.display = 'none'
      resetGraph()
    }
    else if (className == 'tab2d'){
      opps.style.display = 'none'
      leads.style.display = 'none'
      closed.style.display = 'none'
      lost.style.display = 'flex'
    }
  }
}

function updateGraph(){
  setTimeout(() => {
    var barClosedHeight = document.user.barClosedHeight
    var barUCHeight = document.user.barUCHeight
    var barOfferHeight = document.user.barOfferHeight
    var barTourHeight = document.user.barTourHeight
    var barSearchHeight = document.user.barSearchHeight
//    var barLeadHeight = document.user.barLeadHeight
    var pct = .8
    document.getElementById('barClosed').style.height = (barClosedHeight * pct) + '%'
    document.getElementById('barUC').style.height = (barUCHeight * pct) + '%'
    document.getElementById('barOffer').style.height = (barOfferHeight * pct) + '%'
    document.getElementById('barTour').style.height = (barTourHeight * pct) + '%'
    document.getElementById('barSearch').style.height = (barSearchHeight * pct) + '%'
//    document.getElementById('barLead').style.height = (barLeadHeight * pct) + '%'
    for (var i = 0; i < 5; i++){
      document.getElementsByClassName('num')[i].style.opacity = 1
    }
    
    document.getElementById('submitCount').style.opacity = 1
    document.getElementById('closedCount').style.opacity = 1
    document.getElementById('sellerCount').style.opacity = 1
    document.getElementById('closedSum').style.opacity = 1
    document.getElementsByClassName('leaderboardList')[0].style.opacity = 1
  }, 10)
}

function resetGraph(){
  document.getElementById('barClosed').style.height = 0
  document.getElementById('barUC').style.height = 0
  document.getElementById('barOffer').style.height = 0
  document.getElementById('barTour').style.height = 0
  document.getElementById('barSearch').style.height = 0
//  document.getElementById('barLead').style.height = 0
  for (var i = 0; i < 5; i++){
    document.getElementsByClassName('num')[i].style.opacity = 0
  }
  
  document.getElementById('submitCount').style.opacity = 0
  document.getElementById('closedCount').style.opacity = 0
  document.getElementById('sellerCount').style.opacity = 0
  document.getElementById('closedSum').style.opacity = 0
  document.getElementsByClassName('leaderboardList')[0].style.opacity = 0
}

</script>