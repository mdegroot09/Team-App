<script>

window.addEventListener('load', load())

function load(){
  
  // show loading view
  showLoading(true, 'pulling user info')
  
  // Get user info
  google.script.run  
  // if successful, display the data 
  .withSuccessHandler(function(res){
    document.user = res.user
    displayUserInfo(res.user) // display user info on DOM
    updateListingAgents(res.listingAgents) // add listing agents to dropdown options
    runGetData('collecting referrals') // display data based on user info
  })
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
  })
  .getUserInfo()
}

function runGetData(loadText){

  var user = document.user

  showLoading(true, loadText) // show loading view

  // Get data from spreadsheet 
  google.script.run
  // if successful, display the data 
  .withSuccessHandler(function(res){
    document.data = res.data
    document.citiesZips = res.citiesZips
    showData(res.data) // show the referral data
    updateDash(res.data)
    showLoading(false, '') // hide loading view
    updateBuyerAgents(res.data)
    console.log('Page is loaded')
  })
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
  })
  .getData(user) // run function in gs file to pull data
}

function displayUserInfo(user){
  var userInfoHTML = ''
  userInfoHTML += '<div>' + user.userName + '</div>'
  userInfoHTML += '<div id="userType">' + user.userType + '</div>'
  document.getElementById('userInfo').innerHTML = userInfoHTML
}

function showData(data){

  // display buyer names
  var buyerNamesHTML = ''
  var buyerAgentsHTML = ''
  var stagesHTML = ''
  var listingAgentsHTML = ''
  
  // display data if there is any
  if (data.length > 0){
    for (var i = 0; i < data.length; i++){
      var background, bottomBorder, stage, lost, bottomLeftRadius, bottomRightRadius;
      
      // show lost if applicable, otherwise show stage
      if (data[i].status == 'Lost'){
        stage = data[i].status
        lost = ' lost'
      }
      else {
        stage = data[i].stage
        lost = ''
      }
      
      // show solid bottom border
      if (i !== (data.length - 1)){
        bottomBorder = ''
        bottomLeftRadius = ''
        bottomRightRadius = ''
      }
      else {
        bottomBorder = ' bottom'
        bottomLeftRadius = '; border-bottom-left-radius: 5px;'
        bottomRightRadius = '; border-bottom-right-radius: 5px;'
      }
      
      // set class name per row number for background color
      if (i % 3 === 0){
        background = 'rowOne'
      }
      else if (i % 3 === 1){
        background = 'rowTwo'
      }
      else {
        background = 'rowThree'
      }
    
      buyerNamesHTML += '<div class="rowEach ' + background + bottomBorder + '" style="border-left: solid 1px #58dbc2' + bottomLeftRadius + '"><span>' + data[i].buyerName + '</span></div>'
      buyerAgentsHTML += '<div class="rowEach ' + background + bottomBorder + '"><span>' + data[i].buyerAgent + '</span></div>'
      stagesHTML += '<div class="rowEach ' + background + bottomBorder + lost + '"><span>' + stage + '</span></div>'
      listingAgentsHTML += '<div class="rowEach ' + background + bottomBorder + '" style="border-right: solid 1px #58dbc2' + bottomRightRadius + '"><span>' + data[i].listingAgent + '</span></div>'
    }
  }
  
  // if no data, show empty row
  else {
    buyerNamesHTML += '<div class="rowEach rowOne bottom" style="border-left: solid 1px #58dbc2; border-bottom-left-radius: 5px;"><span>No referrals</span></div>'
    buyerAgentsHTML += '<div class="rowEach rowOne bottom"></div>'
    stagesHTML += '<div class="rowEach rowOne bottom"></div>'
    listingAgentsHTML += '<div class="rowEach rowOne bottom" style="border-right: solid 1px #58dbc2; border-bottom-right-radius: 5px;"></div>'
  }
  
  document.getElementById('showBuyers').innerHTML = buyerNamesHTML
  document.getElementById('showBuyerAgents').innerHTML = buyerAgentsHTML
  document.getElementById('showStages').innerHTML = stagesHTML
  document.getElementById('showListingAgents').innerHTML = listingAgentsHTML
}

function updateListingAgents(listingAgents){
  var dropdownLA = document.getElementById('dropdownLA')
  var html1 = dropdownLA.innerHTML
  var agentFilter = document.getElementById('la')
  var html2 = agentFilter.innerHTML
  
  for (var i = 0; i < listingAgents.length; i++){
    html1 += '<option value="' + (i + 1) + '">' + listingAgents[i] + '</option>'
  }
  
  for (var i = 0; i < listingAgents.length; i++){
    html2 += '<option value="' + (i + 1) + '">' + listingAgents[i] + '</option>'
  }
  
  // update html to show listing agents in dropdown
  dropdownLA.innerHTML = html1
  agentFilter.innerHTML = html2
  
  // if user is listing agent, search for name in la dropdown then lock
  var user = document.user
  if (user.userType == 'Listing Agent'){
    var value
    listingAgents.forEach(function(agent, i){
      if (agent == user.userName){
        value = i + 1
      }
    })
    
    // lock la dropdown if user is found 
    if (value){
      dropdownLA.style.background = '#ededed'
      dropdownLA.style.cursor = 'default'
      dropdownLA.disabled = true
      dropdownLA.value = value
      
      // update value of agentFilter to logged in la
      agentFilter.value = value
    }
  }
  
  // if not listing agent, show la dropdown
  else {
    document.getElementsByClassName('agentFiltersDiv')[1].style.display = 'flex'
  }
  
  if (user.userType == 'Admin'){
    document.getElementById('notesReferral').style.height = '145px'
    document.getElementsByClassName('radiusAgent')[0].style.display = 'flex'
    document.getElementById('radius').value = '20'
  }
}

function showLoading(show, text){
  var displayBack
  if (show){
    displayBack = 'flex'
  }
  else {
    displayBack = 'none'
  }
  document.getElementById('loadBack').style.display = displayBack
  document.getElementById('loadingText').innerText = text
}

function showMessage(success, text){
  var e = document.getElementById('message')
  e.innerText = text
  e.style.display = 'block'
  
  // show success message
  if (success){
    e.style.background = '#cff9f1'
    e.style.color = '#45c2aa'
    e.style.border = '#45c2aa 1px solid'
  }
  
  // show failure message
  else {
    e.style.background = '#f4cccc'
    e.style.color = '#b60000'
    e.style.border = '#b60000 1px solid'
  }
    
  setTimeout(function(){ 
    e.style.display = 'none' 
  }, 7000)
}

function updateDash(data){
  var submitCount = data.length
  var closedCount = data.filter(function(buyer){
    return buyer.stage == 'Closed'
  }).length
  var sellerCount = data.filter(function(buyer){
    return buyer.source == 'L.A. Seller>Buyer'
  }).length
  if (submitCount){
    var sellerPct = (sellerCount / submitCount) * 100
    var pctPart1 = String(sellerPct).split('.')[0]
    var pctPart2 = String(sellerPct).split('.')[1]
    if (!pctPart2){
      pctPart2 = '0' 
    }
    sellerPct = Number(pctPart1 + '.' + String(pctPart2).split('')[0])
  }
  else {
    sellerPct = 0
  }
  
  var closedSum = closedCount * 600
  
  document.getElementById('submitCount').innerText = submitCount
  document.getElementById('closedCount').innerText = closedCount
  document.getElementById('sellerPct').innerText = sellerPct + '%'
  document.getElementById('closedSum').innerText = '$' + closedSum
  
  setupGraph(data)
  
  // get leaderboard data then update
  runGetLeaderboard()
}

function setupGraph(data){
  var numUC = data.filter(function(buyer){
    return buyer.stage == 'UC' && buyer.status != 'Lost'
  }).length
  var numOffer = data.filter(function(buyer){
    return buyer.stage == 'Offering' && buyer.status != 'Lost'
  }).length
  var numTour = data.filter(function(buyer){
    return buyer.stage == 'Touring' && buyer.status != 'Lost'
  }).length
  var numSearch = data.filter(function(buyer){
    return buyer.stage == 'Searching' && buyer.status != 'Lost'
  }).length
  var numLead = data.filter(function(buyer){
    // return (buyer.stage == 'New Lead' || buyer.stage == 'Warm Lead' || buyer.stage == 'Cold Lead')
    return ((buyer.stage == 'New Lead' || buyer.stage == 'Warm Lead') && buyer.status != 'Lost')
  }).length
  
  document.getElementById('numUC').innerText = numUC
  document.getElementById('numOffer').innerText = numOffer
  document.getElementById('numTour').innerText = numTour
  document.getElementById('numSearch').innerText = numSearch
  document.getElementById('numLead').innerText = numLead
  
  var counts = [numUC, numOffer, numTour, numSearch, numLead]

  setBarHeights(counts)
}

function setBarHeights(counts){
//  var numHighest = counts.sort(function(a, b){return b-a})[0]
  var numHighest = Math.max(...counts)
  
  if (numHighest > 0){
    document.user.barUCHeight = Math.round((counts[0] / numHighest) * 100)
    document.user.barOfferHeight = Math.round((counts[1] / numHighest) * 100)
    document.user.barTourHeight = Math.round((counts[2] / numHighest) * 100)
    document.user.barSearchHeight = Math.round((counts[3] / numHighest) * 100)
    document.user.barLeadHeight = Math.round((counts[4] / numHighest) * 100)
  }
  else {
    document.user.barUCHeight = 0
    document.user.barOfferHeight = 0
    document.user.barTourHeight = 0
    document.user.barSearchHeight = 0
    document.user.barLeadHeight = 0
  }
}

function runGetLeaderboard(){
  // Get user info
  google.script.run  
  // if successful, display the data 
  .withSuccessHandler(function(res){
    updateLeaderboard(res)
  })
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
  })
  .getLeaderboard()
}

function updateLeaderboard(leaders){
  var e = document.getElementsByClassName('leaderboardList')[0]
  var userName = document.user.userName
  
  var html = ''
  leaders.forEach(function(leader, i){
    name = String(leader.name).trim()
    var style = ''
    if (name == userName){
      style = ' style="font-weight: 600"'
    }
  
    html += (
      '<div class="miniText leader">' +
        '<div class="leaderPlace"' + style + '>' + (i + 1) + '.</div>' +
        '<div class="leaderName"' + style + '>' + leader.name + '</div>' +
        '<div class="leaderCount"' + style + '>' + leader.count + '</div>' +
      '</div>'
    )
  })
  
  e.innerHTML = html
}

function updateBuyerAgents(data){
  var e = document.getElementById('ba')
  var baName = e.options[e.selectedIndex].text
  var value
  
  var buyerAgents = []
  var unassigned = 0
  data.forEach(function(lead){
    if (buyerAgents.indexOf(lead.buyerAgent) < 0){
      if (lead.buyerAgent){
        buyerAgents.push(lead.buyerAgent)
      }
      else {
        unassigned += 1
      }
    }
  })
  
  var html = '<option value="0">All</option>'
  
  buyerAgents.sort()
  if (unassigned > 0){
    buyerAgents.splice(0, 0, 'None')
  }
  
  for (var i = 0; i < buyerAgents.length; i++){
    if (buyerAgents[i] == baName && baName){
      html += '<option selected value="' + (i + 1) + '">' + buyerAgents[i] + '</option>'
    }
    else {
      html += '<option value="' + (i + 1) + '">' + buyerAgents[i] + '</option>'
    }
  }
  
  e.innerHTML = html
}

</script>