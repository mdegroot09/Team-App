<script>

window.addEventListener('load', function() {
  console.log('Page is loaded')
  
  // show loading view
  showLoading(true) 
  
  // Get user info
  google.script.run  
  // if successful, display the data 
  .withSuccessHandler(function(res){
    document.user = res
    displayUserInfo(res) // display user info on DOM
    runGetData(res) // display data based on user info
  })
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
  })
  .getUserInfo()
  
})

function runGetData(user){

  showLoading(true) // show loading view

  // Get data from spreadsheet 
  google.script.run
  // if successful, display the data 
  .withSuccessHandler(function(res){
    showData(res) // show the data
    showLoading(false) // hide loading view
  })
  // if error
  .withFailureHandler(function(err){
    console.error("error occured", err);
  })
  .getData(user) // run function in gs file to pull data
  
}

function displayUserInfo(user){
  var userInfoHTML = ''
  userInfoHTML += '<div>' + user.userName + '</div>'
  userInfoHTML += '<div id="userType">' + user.userType + '</div>'
  document.getElementById('userInfo').innerHTML = userInfoHTML
}

function showData(data){

  // display buyer names
  var buyerNamesHTML = ''
  var buyerAgentsHTML = ''
  var stagesHTML = ''
  var listingAgentsHTML = ''
  for (var i = 0; i < data.length; i++){
    var background, bottom
    
    if (i !== (data.length - 1)){
      bottom = ''
    }
    else {
      bottom = ' bottom'
    }
    
    if (i % 3 === 0){
      background = 'rowOne'
    }
    else if (i % 3 === 1){
      background = 'rowTwo'
    }
    else {
      background = 'rowThree'
    }
  
    buyerNamesHTML += '<div class="row ' + background + bottom + '" style="border-left: solid 1px #58dbc2"><span>' + data[i].buyerName + '</span></div>'
    buyerAgentsHTML += '<div class="row ' + background + bottom + '"><span>' + data[i].buyerAgent + '</span></div>'
    stagesHTML += '<div class="row ' + background + bottom + '"><span>' + data[i].stage + '</span></div>'
    listingAgentsHTML += '<div class="row ' + background + bottom + '" style="border-right: solid 1px #58dbc2"><span>' + data[i].listingAgent + '</span></div>'
  }
  
  document.getElementById('showBuyers').innerHTML = buyerNamesHTML
  document.getElementById('showBuyerAgents').innerHTML = buyerAgentsHTML
  document.getElementById('showStages').innerHTML = stagesHTML
  document.getElementById('showListingAgents').innerHTML = listingAgentsHTML
}

function showLoading(show){
  var displayBack = ''
  var displayLoading = ''
  if (show){
    displayBack = 'block'
    displayLoading = 'in-line'
  }
  else {
    displayBack = 'none'
    displayLoading = 'none'
  }
  document.getElementById('darkBack').style.display = displayBack
  document.getElementById('loading').style.display = displayBack
}

</script>